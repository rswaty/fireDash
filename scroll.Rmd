---
title: "Fire then and now: a LANDFIRE powered assessment"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    
self_contained: true
---

<style type="text/css"> .sidebar { overflow: auto; } </style>

    
    ```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(tigris)
library(dplyr)
library(leaflet)
library(tidyverse)
library(sf)
library(rgdal)
library(htmlwidgets)


# load data in 'global' chunk so it can be shared by all users of the dashboard
# Chord Diagram
library(chorddiag)
library(igraph)
library(readr)
library(tidygraph)

# read in data
histFireGVchord <- read_csv("data/histFireGVchord.csv")
# View(histFireGVchord)

#convert to matrix
histFireGVchordMatrix<-as.matrix(as_adjacency_matrix(as_tbl_graph(histFireGVchord),attr = "acres"))

#clean up matrix (could be cleaner!)
histFireGVchordMatrix = subset(histFireGVchordMatrix, select = -c(1:7))

histFireGVchordMatrix2 <- histFireGVchordMatrix[-c(8:10),]
```

One burning issue.
========================================================

## blah

<font size="6"> Wildfire is a growing issue. </font>



```{r animatedPlotly, fig.height=6}
# insert choroMap.html URL
htmltools::tags$iframe(title = "My embedded document", src = "plotly.html", frameborder = "1", width = "100%", height="600", vspace="30")

```
<br>



Column {.sidebar}
-----------------------------------------------------------------------

### <b><font  size="4em" color="#000000">Annual acres burned has grown from ~1 M acres in 1984 to over 10M acres in 2020. <br> <br> Click the play button at the lower right to see the trend.</font></b>

<br>
This is not news for anyone in the fire business.  What is not captured here are the lives impacted, structures destroyed, habitats fundamentally altered (often beyond what fires would naturally do because of unnatural fuels buildup) and resources used in suppression.

**Question:** how do you think this compares to what would have burned in the years just prior to European colonization?

Data for the lower 48 United States from the Monitoring Trends in Burn Severity program (https://www.mtbs.gov/).  




Historical fire by state
========================================================
## blah


<font size="6"> Compare historical patterns below to where you see most fires occurring today. </font>

```{r choropleth, fig.height=7}
# insert choroMap.html URL
htmltools::tags$iframe(title = "My embedded document", src = "choroMapSimple.html", frameborder = "1", width = "90%", height="700", vspace="30")

```


Column {.sidebar}
-----------------------------------------------------------------------

### <b><font  size="4em" color="#000000">There was ~172,000,000 acres of fire annually prior to European colonization</font></b>   

Prior to European colonization most of the fires were located in the central and eastern regions, and were most common in the grassland ecosystems, where replacement fires could have happened every 1-3 years.  The pine, oak and hickory forests of the east (especially the longleaf pine ecosystems of the southeast) would typically have surface fires every 5-10 years, with replacement fires being rare. 

**Hover over a state to get historical percentage burned annually by fire type.**

* Surface fire = 0-25% top kill
* Mixed fire = 26-75% top kill
* Replacement fire = 76-100% top kill

Fire and Ecosystems
=========================================================
## blah

<font size="6"> Most fire occurred in grasslands historically. </font>

```{r waffle, fig.height=6.5, fig.width=10}
knitr::include_graphics("test.png") 
```

<br>

```{r groupvegconversion map, fig.height=7, fig.width=10}
knitr::include_graphics("groupVeg.jpg") 
```




Column {.sidebar}
-----------------------------------------------------------------------

### <b><font  size="4em" color="#000000">Fire severity varied by ecosystem type</font></b>   
Ecosystems have varying levels of different fire types (aka severity; surface, mixed or replacement).  




Past vs. Present {data-width=600}
========================================================================

Column {.sidebar}
-----------------------------------------------------------------------

### <b><font  size="4em" color="#000000">Fire by state</font></b>   

This chart summarizes fire past (yellow dots) and present (green dots) for the lower 48 states.  


Column {data-size=900}
----------------------------------------------------------------

```{r dumbbell, fig.height=9, fig.width=10}
# horizontal lollipop chart

library(tidyverse)
library(scales)
library(extrafont)
library(ggplot2) 
library(ggalt)   
library(plotly)


currentFireAcresStates <- read_csv("data/currentFireAcresStates.csv")
#View(currentFireAcresStates)

histAreaBurnedbyState <- read_csv("data/histAreaBurnedbyState.csv")
#View(histAreaBurnedbyState)

historicalCurrentFire <- merge(currentFireAcresStates, histAreaBurnedbyState, by = "state")

historicalCurrentFire <- historicalCurrentFire %>%
  mutate(difference = historic_acres_burned - currentAverageAcres)


historicalCurrentFire$state <- factor(historicalCurrentFire$state , levels = rev(unique(historicalCurrentFire$state)))

write.csv(historicalCurrentFire, file = "historicalVScurrentDraft.csv")



# ggplot(historicalCurrentFire, aes(x=currentAverageAcres, xend=historic_acres_burned, y=state)) + 
#   #create a thick line between x and xend instead of using defaut 
#   #provided by geom_dubbell
#   geom_segment(aes(x=currentAverageAcres, 
#                    xend=historic_acres_burned, 
#                    y=state, 
#                    yend=state), 
#                color="#b2b2b2", size=1.5)+
#   geom_dumbbell(color="light blue", 
#                 size_x=4.0, 
#                 size_xend = 4.0,
#                 colour_x="#edae52", 
#                 colour_xend = "#9fb059")+
#   labs(x=NULL, y=NULL) +
#   theme_bw(base_size = 14, base_family = "Calisto MT") +
#   scale_x_continuous(label=comma)

##  take 2
# add mean lines

avgCur <- mean(historicalCurrentFire$currentAverageAcres)
avgHist <- mean(historicalCurrentFire$historic_acres_burned)


db <-
  ggplot(historicalCurrentFire, aes(x=currentAverageAcres, xend=historic_acres_burned, y=state)) + 
  #create a thick line between x and xend instead of using defaut 
  #provided by geom_dubbell
  geom_segment(aes(x=currentAverageAcres, 
                   xend=historic_acres_burned, 
                   y=state, 
                   yend=state), 
               color="#b2b2b2", size=1.5)+
  geom_dumbbell(color="light blue", 
                size_x=4.0, 
                size_xend = 4.0,
                colour_x="#edae52", 
                colour_xend = "#9fb059")+
  labs(x=NULL, y=NULL) +
  theme_bw(base_size = 14, base_family = "Calisto MT") +
  scale_x_continuous(label=comma) + 
  geom_vline(xintercept = avgCur) +
  geom_vline(xintercept = avgHist)






vlineCUR <- function(x = avgCur, color = "grey") {
  list(
    type = "line", 
    y0 = 0, 
    y1 = 1, 
    yref = "paper",
    x0 = x, 
    x1 = x, 
    line = list(color = color)
  )
}

vlineHIST <- function(x = avgHist, color = "grey") {
  list(
    type = "line", 
    y0 = 0, 
    y1 = 1, 
    yref = "paper",
    x0 = x, 
    x1 = x, 
    line = list(color = color)
  )
}








fig <- plot_ly(historicalCurrentFire, color = I("gray80"))
fig <- fig %>% add_segments(x = ~currentAverageAcres, xend = ~historic_acres_burned, y = ~state, yend = ~state, showlegend = FALSE)
fig <- fig %>% add_markers(x = ~currentAverageAcres, y = ~state, name = "Current", color = I("#edae52"), showlegend = FALSE)
fig <- fig %>% add_markers(x = ~historic_acres_burned, y = ~state, name = "Historical", color = I("#9fb059"), showlegend = FALSE)
fig <- fig %>% layout(
  xaxis = list(title = "Acres (in millions)"),
  yaxis = list(title = "", dtick = 1),
  margin = list(l = 65),
  shapes = list(vlineCUR(), vlineHIST())
)

fig
```


This is a draft
=================================================================

We hope to complete and refine this dashboard to be used by the conservation community to help set the stage for conversations about fire management.  

This dashboard needs (at the least):

* data sources and methods text
* design improvement
* links to resources

